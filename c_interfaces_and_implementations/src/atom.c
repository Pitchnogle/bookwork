#include <string.h>
#include <limits.h>

#include "assert.h"
#include "mem.h"
#include "atom.h"

// -----------------------------------------------------------------------------
// Definitions
// -----------------------------------------------------------------------------

static struct atom {
  struct atom *link;
  int len;
  char *str;
} *buckets[2048];

// -----------------------------------------------------------------------------
// MACROS
// -----------------------------------------------------------------------------

#define NELEMS(x) ((sizeof (x)) / (sizeof ((x)[0])))

// -----------------------------------------------------------------------------
// Data
// -----------------------------------------------------------------------------

static unsigned long scatter[] = {
  0789561251, 1277687359, 1791104709, 0535243057, 0207980834, 0581900805, 
  0831813950, 0017812950, 1094745319, 1557653690, 1650818471, 0129131397, 
  1695898899, 1129371776, 0515399906, 0743169127, 1694838946, 0723521937, 
  0028587083, 0211175999, 2008923011, 1400119706, 1014590985, 0234772822, 
  1314181434, 0161714049, 0078668409, 0359726707, 1985807065, 0527071767, 
  1217143377, 0627884668, 1804759126, 0860764438, 1163127725, 2012739960, 
  1442665243, 1994941675, 2030552910, 0389926914, 1405111718, 1533887733, 
  0519058312, 0953526969, 0515775862, 1034458218, 1696696096, 0063131160, 
  1757980156, 1725283180, 0274307160, 1619419519, 0977919238, 1288898145, 
  1854192341, 0144617024, 1450612194, 1932860750, 0504343732, 1288935612, 
  0312448869, 1721487109, 1916820280, 2117207995, 0434767899, 0932464358, 
  1982464308, 1877433142, 0779922385, 1865533570, 0119876409, 0037550455, 
  1251937656, 0638934721, 0991077424, 1767713518, 1673392939, 0540289873, 
  1830844678, 1283889447, 0118089405, 2105151838, 0755825319, 1096008643, 
  1246566336, 0462534012, 1240625667, 0549694882, 0247911115, 1744969399, 
  1838630494, 0560359984, 1318972860, 1607967127, 0530084332, 1753740759, 
  0392947837, 0365064992, 1483690254, 1172870222, 0083114914, 1603566663, 
  1210420678, 1335052570, 0095017736, 0054014454, 0955282440, 1768410675, 
  0594304327, 0638643471, 0904816475, 0712393732, 0596311661, 1660641794, 
  1808402375, 1842877997, 2123175806, 0901544395, 0245089232, 0223603273, 
  0499030146, 2083719726, 0783963258, 1818003007, 1544203205, 1314047590, 
  1424260118, 1937151042, 1679112582, 0760466724, 0962537617, 1762227496, 
  0216549739, 0025474647, 0949796419, 0311567475, 0079489101, 1905078859, 
  2079978151, 0673793429, 0396238682, 0837310978, 1386187161, 0992550344, 
  0350469124, 1047105889, 0687944693, 0326161282, 1948650284, 0933033925, 
  0549764556, 0300196782, 0869270004, 1333727814, 2118199789, 0265989561, 
  0500291756, 1394976260, 0055656956, 0031920690, 0007959336, 1018194573, 
  1794148186, 0224509076, 1043669220, 0596460957, 0536076551, 1123158321,
  0354056169, 0468571054, 1796951750, 0750294851, 1305882032, 1035655264,
  1742845195, 1656351156, 2082761153, 0283306241, 1982512439, 1883927789,
  1216340166, 0384793347, 0036640923, 2085610170, 1718521161, 0007357065,
  0204116084, 0071329269, 1402333325, 0259773040, 0103249959, 1410292661,
  1277967613, 1897398145, 1634801737, 0174153185, 0346375455, 0023394641,
  1297311506, 0700431624, 0491965695, 0946779609, 1450726475, 1797847728,
  1982434873, 1046088023, 1306715236, 1917712378, 1329394264, 1141744027, 
  1654156519, 0398250782, 1526537374, 1690797442, 0336377305, 1097574887, 
  1698154507, 0540493389, 1168904156, 0953004184, 0800266429, 1272154115, 
  0215813198, 2078234042, 1022068613, 1850614935, 0104903579, 1368444068,
  1874009576, 1402215085, 2068875692, 0218491624, 0201511046, 1372118519,
  2016339352, 0036462271, 0270722894, 1175570940, 1954174649, 1600117158,
  0169831320, 1460847520, 1998367941, 1696368694, 1004161315, 0187261598,
  0646459934, 0554832174, 0727754987, 1815364090, 1507836359, 1528021416,
  0940034558, 1723649557, 1458771810, 1962103171
};

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Public Functions
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

int atom_length(const char *str)
{
  struct atom *p;
  int i;

  assert(str);

  for (i = 0; i < NELEMS(buckets); i++) {
    for (p = buckets[i]; p; p = p->link) {
      if (p->str == str) {
        return p->len;
      }
    }
  }
  assert(0);
  return 0;
}

const char* atom_new(const char *str, int len)
{
  unsigned long h;
  int i;
  struct atom *p;

  assert(str);
  assert(len >= 0);

  for (h = 0, i = 0; i < len; i++) {
    h = (h << 1) + scatter[(unsigned char)str[i]];
  }

  h %= NELEMS(buckets);
  for (p = buckets[h]; p; p = p->link) {
    if (len == p->len) {
      for (i = 0; i < len && p->str[i] == str[i]; ) {
        i++;
      }
      if (i == len) {
        return p->str;
      }
    }

    p = ALLOC(sizeof (*p) + len + 1);
    p->len = len;
    p->str = (char*)(p + 1);
    if (len > 0) {
      memcpy(p->str, str, len);
    }
    p->str[len] = '\0';
    p->link = buckets[h];
    buckets[h] = p;
  }
  return p->str;
}

const char* atom_string(const char *str)
{
  assert(str);

  return atom_new(str, strlen (str));
}

const char* atom_int(long n)
{
  char str[43];
  char *s = str + sizeof (str);
  unsigned long m;

  if (n == LONG_MIN) {
    m = LONG_MAX + 1UL;
  }
  else if (n < 0) {
    m = -n;
  }
  else {
    m = n;
  }
  do {
    *--s = m % 10 + '0';
  } while ((m /= 10) > 0);

  if (n < 0) {
    *--s = '-';
  }

  return atom_new(s, (str - sizeof (str)) - s);
}
